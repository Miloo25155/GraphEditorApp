<!DOCTYPE html>
<html>
<head>
	<title>No Regression App - Dev in Progress</title>
	<script src="https://cdn.jsdelivr.net/npm/vue"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
 	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">
 	<link rel="stylesheet" href="index.css">
</head>
<body>
	<div id="appContainer" v-on:click="handleClick($event)">
		<div v-for="(point, index) in points" v-on:mousedown="followMouse(index)"
			 v-bind:id="'point_' + index" v-bind:class="{ 'selected': currentSelectedPointIndex === index }" class="pointInContainer">
			<span class="fa fa-info-circle"></span>
		</div>
	</div>
</body>
</html>

<script>
	var mainVue = new Vue({
		el: "#appContainer",
		data: {
			points:[
				{x: 15, y: 50},
				{x: 50, y: 80}
			],
			currentSelectedPointIndex: -1,
			pointSize: 10
		},
		mounted: function(){
			this.calculatePointPosition();
		},
		methods:{
			calculatePointPosition: function(){
				for (let i = 0; i < this.points.length; i++) {
					let point = document.getElementById("point_"+i);

					point.style.left = this.points[i].x + "px";
					point.style.top = this.points[i].y + "px";
				}
			},
			calculateSinglePointPosition: function(index){
				let point = document.getElementById("point_"+index);
				point.style.left = this.points[index].x + "px";
				point.style.top = this.points[index].y + "px";
			},
			addPoint: function(x, y){
			    let newPoint = { x: x, y: y };

				this.points.push(newPoint);

				Vue.nextTick(function(){
					this.calculateSinglePointPosition(this.points.length-1);
				}.bind(this))
			},
			handleClick: function(event){
				debugger;
				var xScrollPos = document.documentElement.scrollLeft;
			    var yScrollPos = document.documentElement.scrollTop;

				let xPosition = xScrollPos + event.clientX - 15;
			    let yPosition = yScrollPos + event.clientY - 15;

			    let existingPoint = this.points.filter(function(x){
			    	return x.x >= xPosition - this.pointSize && x.x <= xPosition + this.pointSize
			    		&& x.y >= yPosition - this.pointSize && x.y <= yPosition + this.pointSize;
			    }.bind(this))

			    //if there is a point at the same position
			    if(existingPoint != null && existingPoint.length > 0){
			    	let indexOfExistingPoint = this.points.indexOf(existingPoint[0]);
			    	//if we already have a point selected we select the new one instead
			    	if(this.currentSelectedPointIndex != indexOfExistingPoint) {
			    		this.currentSelectedPointIndex = indexOfExistingPoint;
			    	//if we click on the selected point we deselect it
			    	} else{
			    		this.currentSelectedPointIndex = -1;
			    	}
			    //if no point at mouse position, and a point is selected, we move it to current position
			    } else if(this.currentSelectedPointIndex != -1){
		    		this.points[this.currentSelectedPointIndex] = { x: xPosition, y: yPosition };
		    		this.calculateSinglePointPosition(this.currentSelectedPointIndex);
		    	//else if no point selected and no point at current position, we add  a new one
			    } else{
					this.addPoint(xPosition, yPosition);
			    }
			},

			dragElement: function(event){
				if(this.currentSelectedPointIndex === -1){
					return;
				}

				var xScrollPos = document.documentElement.scrollLeft;
			    var yScrollPos = document.documentElement.scrollTop;

				let xPosition = xScrollPos + event.clientX - 15;
			    let yPosition = yScrollPos + event.clientY - 15;

			    let newPosition = { x: xPosition, y: yPosition };

			    this.$set(this.points, this.currentSelectedPointIndex, newPosition);
			    this.calculateSinglePointPosition(this.currentSelectedPointIndex);
			},

			followMouse: function(index){
				debugger;
				this.currentSelectedPointIndex = index;
			}
		}
	})
</script>